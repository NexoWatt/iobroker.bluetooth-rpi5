<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>bluetooth-rpi5</title>

  <!-- ioBroker Admin uses Materialize. Use the canonical paths! -->
  <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css"/>
  <link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>

  <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="../../socket.io/socket.io.js"></script>
  <script type="text/javascript" src="../../lib/js/materialize.js"></script>
  <script type="text/javascript" src="../../js/translate.js"></script>
  <script type="text/javascript" src="../../js/adapter-settings.js"></script>
  <script type="text/javascript" src="words.js"></script>
  <script type="text/javascript" src="index_m.js"></script>

  <style>
    .bt-mono { font-family: monospace; }
    .bt-small { font-size: 0.9rem; }
    .bt-compact td { padding-top: 8px; padding-bottom: 8px; }
    .bt-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .bt-chip { margin-right: 6px; }
    .bt-muted { opacity: 0.75; }
  </style>
</head>

<body>
<div class="m adapter-container">

  <!-- Header -->
  <div class="row" style="margin-bottom: 0;">
    <div class="col s12">
      <div style="display:flex; align-items:center; gap:12px; padding: 10px 0 4px 0;">
        <img src="bluetooth-rpi5.png" alt="BT" style="width:40px; height:40px;"/>
        <div>
          <div style="font-size: 1.35rem; font-weight: 600; line-height: 1.2;">
            <span class="translate" data-lang="title">Bluetooth (BLE) - Raspberry Pi 5</span>
          </div>
          <div class="grey-text bt-small">
            <span class="translate" data-lang="subtitle">Scan, pair/trust and manage multiple BLE devices via BlueZ (D-Bus).</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="row" style="margin-bottom: 0;">
    <div class="col s12">
      <ul class="tabs">
        <li class="tab col s6"><a href="#tab-general" class="translate" data-lang="tab_general">General</a></li>
        <li class="tab col s6"><a href="#tab-devices" class="translate" data-lang="tab_devices">Devices</a></li>
      </ul>
    </div>
  </div>

  <!-- GENERAL -->
  <div id="tab-general" class="col s12" style="padding-top: 10px;">
    <div class="row">
      <div class="col s12">
        <div class="card">
          <div class="card-content">
            <span class="card-title translate" data-lang="general_settings">General settings</span>

            <div class="row" style="margin-bottom: 0;">
              <div class="input-field col s12 m6">
                <select id="adapter" class="value"></select>
                <label class="translate" data-lang="bluetooth_adapter_select">Bluetooth adapter</label>
                <div class="bt-small grey-text">
                  <span class="translate" data-lang="adapter_hint">Select the installed Bluetooth controller (e.g. hci0). No manual typing required.</span>
                </div>
              </div>

              <div class="col s12 m6" style="display:flex; justify-content:flex-end; align-items:center; gap:10px; padding-top: 10px;">
                <a id="btnRefreshAdapters" class="waves-effect waves-light btn-flat">
                  <i class="material-icons left">refresh</i>
                  <span class="translate" data-lang="refresh">Refresh</span>
                </a>
              </div>
            </div>

            <div class="row" style="margin-bottom: 0;">
              <div class="input-field col s12 m4">
                <input id="scanDurationSec" type="number" min="3" max="300" class="value"/>
                <label for="scanDurationSec" class="translate" data-lang="scan_duration">Scan duration (seconds)</label>
              </div>

              <div class="input-field col s12 m4">
                <input id="reconnectIntervalSec" type="number" min="5" max="3600" class="value"/>
                <label for="reconnectIntervalSec" class="translate" data-lang="reconnect_interval">Reconnect interval (seconds)</label>
              </div>

              <div class="col s12 m4" style="padding-top: 20px;">
                <label>
                  <input id="scanOnStart" type="checkbox" class="value"/>
                  <span class="translate" data-lang="scan_on_start">Scan on start</span>
                </label>
              </div>
            </div>

            <div class="row" style="margin-bottom: 0;">
              <div class="col s12">
                <div class="bt-small orange-text">
                  <i class="material-icons" style="vertical-align: -5px; font-size: 18px;">info</i>
                  <span class="translate" data-lang="polkit_hint">If scan/pair actions fail with “Not authorized”, you likely need a Polkit rule to allow the ioBroker user/group to access BlueZ D-Bus.</span>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DEVICES -->
  <div id="tab-devices" class="col s12" style="padding-top: 10px;">

    <!-- Hidden config field (no manual editing) -->
    <input id="devicesJson" type="hidden" class="value" />

    <div class="row">
      <!-- Nearby / Known devices -->
      <div class="col s12 l7">
        <div class="card">
          <div class="card-content">
            <span class="card-title translate" data-lang="device_discovery">Device discovery</span>

            <div class="row" style="margin-bottom: 0;">
              <div class="input-field col s12 m4">
                <select id="scanTransport">
                  <option value="le" selected>LE</option>
                  <option value="auto">Auto</option>
                  <option value="bredr">BR/EDR</option>
                </select>
                <label class="translate" data-lang="transport">Transport</label>
              </div>

              <div class="input-field col s12 m5">
                <input id="scanFilter" type="text" />
                <label for="scanFilter" class="translate" data-lang="filter">Filter (name / MAC)</label>
              </div>

              <div class="col s12 m3" style="display:flex; justify-content:flex-end; align-items:center; gap:10px; padding-top: 10px;">
                <a id="btnScan" class="waves-effect waves-light btn">
                  <i class="material-icons left">search</i>
                  <span class="translate" data-lang="scan">Scan</span>
                </a>
              </div>
            </div>

            <div class="row" style="margin-bottom: 0;">
              <div class="col s12">
                <div id="scanProgress" class="progress" style="display:none; margin-top: 8px;">
                  <div class="indeterminate"></div>
                </div>
                <div class="bt-small grey-text bt-muted" style="margin-top: 6px;">
                  <span class="translate" data-lang="scan_hint">Like on a smartphone: click Scan, choose a device from the list, and it will be paired/trusted automatically when possible.</span>
                </div>
                <div class="bt-small orange-text bt-muted" style="margin-top: 6px;">
                  <span class="translate" data-lang="warn_pairing">For devices requiring PIN/Passkey, pairing may need bluetoothctl.</span>
                </div>
              </div>
            </div>

            <div class="row" style="margin-top: 8px;">
              <div class="col s12">
                <table class="highlight responsive-table bt-compact" id="scanTable">
                  <thead>
                    <tr>
                      <th class="translate" data-lang="name">Name</th>
                      <th class="translate" data-lang="address">Address</th>
                      <th class="translate" data-lang="rssi">RSSI</th>
                      <th class="translate" data-lang="status">Status</th>
                      <th class="translate" data-lang="actions">Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Configured devices -->
      <div class="col s12 l5">
        <div class="card">
          <div class="card-content">
            <span class="card-title translate" data-lang="configured_devices">Configured devices</span>
            <div class="bt-small grey-text" style="margin-top: 6px;">
              <span class="translate" data-lang="configured_hint">Devices are added from the scan list. No manual MAC entry required.</span>
            </div>

            <div class="row" style="margin-top: 10px;">
              <div class="col s12">
                <table class="striped responsive-table bt-compact" id="cfgTable">
                  <thead>
                    <tr>
                      <th class="translate" data-lang="id">ID</th>
                      <th class="translate" data-lang="name">Name</th>
                      <th class="translate" data-lang="address">Address</th>
                      <th class="translate" data-lang="connect">Auto</th>
                      <th class="translate" data-lang="remove">Remove</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

</div>
</body>
</html>
